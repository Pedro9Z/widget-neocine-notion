<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartelera Neocine Cartagena</title>
    <style>
        :root {
            --primary-color: #ff6b35;
            --secondary-color: #1e3a8a;
            --bg-color: #f8fafc;
            --text-color: #334155;
            --border-color: #e2e8f0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 16px;
        }

        .widget-container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .controls {
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .update-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .update-btn:hover {
            background: #e55a2b;
        }

        .update-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .last-update {
            font-size: 0.8em;
            color: #64748b;
            margin-top: 8px;
        }

        .cinema-section {
            border-bottom: 1px solid var(--border-color);
        }

        .cinema-header {
            background: #f1f5f9;
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .cinema-header:hover {
            background: #e2e8f0;
        }

        .cinema-header h2 {
            font-size: 1.1em;
            color: var(--secondary-color);
        }

        .toggle-icon {
            transform: rotate(0deg);
            transition: transform 0.3s;
        }

        .cinema-section.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .cinema-content {
            padding: 16px;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .cinema-section.collapsed .cinema-content {
            max-height: 0;
            padding: 0 16px;
        }

        .movie-item {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 12px;
            background: white;
        }

        .movie-title {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 8px;
        }

        .movie-premiere {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            margin-left: 8px;
        }

        .movie-times {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .time-slot {
            background: var(--bg-color);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            border: 1px solid var(--border-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc2626;
        }

        .error-icon {
            font-size: 3em;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .widget-container {
                margin: 0;
                border-radius: 0;
            }
            
            .header {
                padding: 16px;
            }
            
            .header h1 {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="header">
            <h1>🎬 Cartelera Neocine Cartagena</h1>
            <p>Circuito Neocine - Espacio Mediterráneo & Mandarache</p>
        </div>
        
        <div class="controls">
            <button class="update-btn" onclick="loadMovies()">🔄 Actualizar</button>
            <div class="last-update" id="last-update">Cargando...</div>
        </div>
        
        <div id="content" class="loading">
            <div class="spinner"></div>
            <p>Cargando carteleras...</p>
        </div>
    </div>

    <script>
        const CORS_PROXY = 'https://api.allorigins.win/get?url=';
        
        const CINEMAS = [
            {
                id: 'espacio-mediterraneo',
                name: 'Circuito Neocine - Espacio Mediterráneo',
                url: 'https://www.neocine.es/cine/4/espacio-mediterraneo--cartagena-/lang/es'
            },
            {
                id: 'mandarache', 
                name: 'Circuito Neocine - Mandarache',
                url: 'https://www.neocine.es/cine/6/mandarache--cartagena-/lang/es'
            }
        ];

        // FUNCIÓN CORREGIDA PARA FECHAS ESPAÑOLAS
        function parseDateSafely(dateString) {
            const dateRegex = /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/;
            const match = dateString.match(dateRegex);
            
            if (match) {
                const day = parseInt(match[1]);
                const month = parseInt(match[2]) - 1; // JavaScript meses 0-11
                const year = parseInt(match[3]);
                
                return new Date(year, month, day);
            }
            
            return null;
        }

        // FUNCIÓN CORREGIDA PARA FORMATO ESPAÑOL
        function formatDateSpanish(date) {
            if (!date || !(date instanceof Date)) return 'Fecha no disponible';
            
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}/${month}/${year}`;
        }

        // FUNCIÓN CORREGIDA PARA TIMESTAMP
        function updateTimestamp() {
            const now = new Date();
            const options = {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Europe/Madrid'
            };
            
            const formatter = new Intl.DateTimeFormat('es-ES', options);
            const timestamp = formatter.format(now);
            
            document.getElementById('last-update').textContent = 
                `Última actualización: ${timestamp}`;
        }

        async function fetchCinemaData(cinema) {
            try {
                const response = await fetch(CORS_PROXY + encodeURIComponent(cinema.url), {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                return data.contents;
            } catch (error) {
                console.error(`Error fetching ${cinema.name}:`, error);
                throw error;
            }
        }

        function parseMovieData(html) {
            const movies = [];
            
            // Buscar títulos de películas
            const titleRegex = /<h[1-6][^>]*>([^<]*(?:película|film|estreno|cine)[^<]*)</h[1-6]>/gi;
            const titleMatches = html.match(titleRegex) || [];
            
            // Buscar horarios
            const timeRegex = /\b(\d{1,2}):(\d{2})\b/g;
            const timeMatches = html.match(timeRegex) || [];
            
            // Buscar indicadores de estreno
            const premiereKeywords = ['estreno', 'nuevo', 'novedad', 'premier'];
            
            titleMatches.forEach((titleMatch, index) => {
                const cleanTitle = titleMatch.replace(/<[^>]*>/g, '').trim();
                
                if (cleanTitle.length > 3 && cleanTitle.length < 100) {
                    const isPremiereText = premiereKeywords.some(keyword => 
                        cleanTitle.toLowerCase().includes(keyword)
                    );
                    
                    movies.push({
                        title: cleanTitle,
                        times: timeMatches.slice(index * 3, (index + 1) * 3),
                        isPremiere: isPremiereText
                    });
                }
            });
            
            return movies.slice(0, 15); // Limitar resultados
        }

        function renderMovies(moviesData) {
            const content = document.getElementById('content');
            
            if (!moviesData || Object.keys(moviesData).length === 0) {
                content.innerHTML = `
                    <div class="error">
                        <div class="error-icon">📭</div>
                        <h3>No hay datos disponibles</h3>
                        <p>No se pudieron cargar las carteleras en este momento.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            Object.entries(moviesData).forEach(([cinemaId, data]) => {
                const cinema = CINEMAS.find(c => c.id === cinemaId);
                const cinemaName = cinema ? cinema.name : cinemaId;
                
                html += `
                    <div class="cinema-section" id="section-${cinemaId}">
                        <div class="cinema-header" onclick="toggleSection('${cinemaId}')">
                            <h2>${cinemaName}</h2>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="cinema-content">
                `;
                
                if (data.error) {
                    html += `
                        <div class="error">
                            <p>⚠️ Error: ${data.error}</p>
                        </div>
                    `;
                } else if (data.movies && data.movies.length > 0) {
                    data.movies.forEach(movie => {
                        html += `
                            <div class="movie-item">
                                <div class="movie-title">
                                    ${movie.title}
                                    ${movie.isPremiere ? '<span class="movie-premiere">ESTRENO</span>' : ''}
                                </div>
                                <div class="movie-times">
                                    ${movie.times.map(time => 
                                        `<span class="time-slot">${time}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p>No hay películas disponibles</p>';
                }
                
                html += '</div></div>';
            });
            
            content.innerHTML = html;
            updateTimestamp();
        }

        function toggleSection(cinemaId) {
            const section = document.getElementById(`section-${cinemaId}`);
            section.classList.toggle('collapsed');
        }

        async function loadMovies() {
            const content = document.getElementById('content');
            const updateBtn = document.querySelector('.update-btn');
            
            // Estado de carga
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Actualizando carteleras...</p>
                </div>
            `;
            updateBtn.disabled = true;
            
            const moviesData = {};
            
            // Cargar datos de cada cine
            for (const cinema of CINEMAS) {
                try {
                    const html = await fetchCinemaData(cinema);
                    const movies = parseMovieData(html);
                    moviesData[cinema.id] = { movies };
                } catch (error) {
                    moviesData[cinema.id] = { 
                        error: `No se pudo obtener información (${error.message})` 
                    };
                }
            }
            
            renderMovies(moviesData);
            updateBtn.disabled = false;
        }

        // Cargar datos al inicio
        document.addEventListener('DOMContentLoaded', loadMovies);
        
        // Auto-actualizar cada 30 minutos
        setInterval(loadMovies, 30 * 60 * 1000);
    </script>
</body>
</html>
